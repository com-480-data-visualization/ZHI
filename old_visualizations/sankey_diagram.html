<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8" />
<title>Sankey Particles</title>
<style>
.node rect {
  cursor: move;
  fill-opacity: .9;
  shape-rendering: crispEdges;
}

.node text {
  pointer-events: none;
  text-shadow: 0 1px 0 #fff;
}

.link {
  fill: none;
  stroke: #000;
  stroke-opacity: .15;
}

.link:hover {
  stroke-opacity: .25;
}

svg {
  position: absolute;
}

canvas {
  position: absolute;
}


</style>
</head>
<body>
<canvas width="1000" height="1000" ></canvas>
<svg width="1000" height="1000" ></svg>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.8.0/d3.js" charset="utf-8" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-sankey/0.4.2/d3-sankey.js" charset="utf-8" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-timer/1.0.5/d3-timer.js" charset="utf-8" type="text/javascript"></script>


    <script type="text/javascript">

var margin = {top: 1, right: 1, bottom: 6, left: 1},
    width = 960 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

var formatNumber = d3.format(",.0f"),
    format = function(d) { return formatNumber(d) + " TWh"; },
    color = d3.scaleOrdinal(d3.schemeCategory20);

var svg = d3.select("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var sankey = d3.sankey()
    .nodeWidth(15)
    .nodePadding(10)
    .size([width, height]);

var path = sankey.link();

var freqCounter = 1;


// Embedding JSON data directly
var energy = {
  "nodes": [
    {
      "name": "2. Bundesliga(early)"
    },

    {
      "name": "Bundesliga(early)"
    },

    {
      "name": "Bundesliga(late)"
    },

    {
      "name": "Bundesliga(mid)"
    },

    {
      "name": "Championship(early)"
    },

    {
      "name": "Championship(late)"
    },

    {
      "name": "Championship(mid)"
    },

    {
      "name": "La Liga 2(early)"
    },

    {
      "name": "La Liga(early)"
    },

    {
      "name": "La Liga(late)"
    },

    {
      "name": "La Liga(mid)"
    },

    {
      "name": "Liga Profesional(early)"
    },

    {
      "name": "Liga Profesional(late)"
    },

    {
      "name": "Liga Profesional(mid)"
    },

    {
      "name": "Ligue 1(early)"
    },

    {
      "name": "Ligue 1(late)"
    },

    {
      "name": "Ligue 1(mid)"
    },

    {
      "name": "Major League Soccer(late)"
    },

    {
      "name": "Major League Soccer(mid)"
    },

    {
      "name": "Premier League(early)"
    },

    {
      "name": "Premier League(late)"
    },

    {
      "name": "Premier League(mid)"
    },

    {
      "name": "Serie A(early)"
    },

    {
      "name": "Serie A(late)"
    },

    {
      "name": "Serie A(mid)"
    },

    {
      "name": "Super Lig(late)"
    },

    {
      "name": "Super Lig(mid)"
    },

    {
      "name": "others(early)"
    },

    {
      "name": "others(late)"
    },

    {
      "name": "others(mid)"
    }
  ],
  "links": [
    {
      "source": 0,
      "target": 29,
      "value": 12
    },

    {
      "source": 29,
      "target": 28,
      "value": 121
    },

    {
      "source": 29,
      "target": 2,
      "value": 3
    },

    {
      "source": 0,
      "target": 3,
      "value": 9
    },

    {
      "source": 3,
      "target": 28,
      "value": 10
    },

    {
      "source": 3,
      "target": 2,
      "value": 31
    },

    {
      "source": 3,
      "target": 17,
      "value": 1
    },

    {
      "source": 0,
      "target": 6,
      "value": 1
    },

    {
      "source": 6,
      "target": 28,
      "value": 11
    },

    {
      "source": 0,
      "target": 18,
      "value": 3
    },

    {
      "source": 18,
      "target": 28,
      "value": 3
    },

    {
      "source": 18,
      "target": 17,
      "value": 23
    },

    {
      "source": 0,
      "target": 21,
      "value": 2
    },

    {
      "source": 21,
      "target": 20,
      "value": 36
    },

    {
      "source": 27,
      "target": 29,
      "value": 98
    },

    {
      "source": 27,
      "target": 21,
      "value": 9
    },

    {
      "source": 21,
      "target": 28,
      "value": 6
    },

    {
      "source": 29,
      "target": 17,
      "value": 3
    },

    {
      "source": 29,
      "target": 20,
      "value": 1
    },

    {
      "source": 1,
      "target": 29,
      "value": 7
    },

    {
      "source": 1,
      "target": 3,
      "value": 34
    },

    {
      "source": 3,
      "target": 20,
      "value": 1
    },

    {
      "source": 3,
      "target": 23,
      "value": 1
    },

    {
      "source": 3,
      "target": 25,
      "value": 3
    },

    {
      "source": 1,
      "target": 10,
      "value": 1
    },

    {
      "source": 10,
      "target": 9,
      "value": 30
    },

    {
      "source": 1,
      "target": 16,
      "value": 2
    },

    {
      "source": 16,
      "target": 9,
      "value": 3
    },

    {
      "source": 16,
      "target": 28,
      "value": 12
    },

    {
      "source": 1,
      "target": 21,
      "value": 2
    },

    {
      "source": 1,
      "target": 24,
      "value": 2
    },

    {
      "source": 24,
      "target": 23,
      "value": 23
    },

    {
      "source": 24,
      "target": 25,
      "value": 3
    },

    {
      "source": 29,
      "target": 23,
      "value": 4
    },

    {
      "source": 1,
      "target": 26,
      "value": 2
    },

    {
      "source": 26,
      "target": 28,
      "value": 4
    },

    {
      "source": 26,
      "target": 25,
      "value": 11
    },

    {
      "source": 4,
      "target": 6,
      "value": 19
    },

    {
      "source": 6,
      "target": 5,
      "value": 27
    },

    {
      "source": 6,
      "target": 20,
      "value": 6
    },

    {
      "source": 4,
      "target": 29,
      "value": 2
    },

    {
      "source": 4,
      "target": 10,
      "value": 1
    },

    {
      "source": 4,
      "target": 18,
      "value": 1
    },

    {
      "source": 4,
      "target": 21,
      "value": 8
    },

    {
      "source": 21,
      "target": 5,
      "value": 11
    },

    {
      "source": 4,
      "target": 24,
      "value": 1
    },

    {
      "source": 27,
      "target": 6,
      "value": 15
    },

    {
      "source": 6,
      "target": 2,
      "value": 1
    },

    {
      "source": 29,
      "target": 25,
      "value": 4
    },

    {
      "source": 27,
      "target": 18,
      "value": 20
    },

    {
      "source": 21,
      "target": 23,
      "value": 4
    },

    {
      "source": 27,
      "target": 24,
      "value": 7
    },

    {
      "source": 29,
      "target": 15,
      "value": 4
    },

    {
      "source": 27,
      "target": 16,
      "value": 10
    },

    {
      "source": 16,
      "target": 15,
      "value": 14
    },

    {
      "source": 7,
      "target": 29,
      "value": 12
    },

    {
      "source": 29,
      "target": 9,
      "value": 8
    },

    {
      "source": 7,
      "target": 10,
      "value": 11
    },

    {
      "source": 10,
      "target": 28,
      "value": 13
    },

    {
      "source": 7,
      "target": 21,
      "value": 1
    },

    {
      "source": 21,
      "target": 9,
      "value": 4
    },

    {
      "source": 8,
      "target": 29,
      "value": 6
    },

    {
      "source": 8,
      "target": 10,
      "value": 26
    },

    {
      "source": 10,
      "target": 5,
      "value": 1
    },

    {
      "source": 10,
      "target": 20,
      "value": 3
    },

    {
      "source": 10,
      "target": 25,
      "value": 1
    },

    {
      "source": 8,
      "target": 13,
      "value": 1
    },

    {
      "source": 13,
      "target": 12,
      "value": 16
    },

    {
      "source": 8,
      "target": 16,
      "value": 1
    },

    {
      "source": 8,
      "target": 18,
      "value": 1
    },

    {
      "source": 8,
      "target": 21,
      "value": 2
    },

    {
      "source": 29,
      "target": 5,
      "value": 4
    },

    {
      "source": 27,
      "target": 13,
      "value": 3
    },

    {
      "source": 27,
      "target": 10,
      "value": 2
    },

    {
      "source": 21,
      "target": 25,
      "value": 5
    },

    {
      "source": 11,
      "target": 29,
      "value": 1
    },

    {
      "source": 11,
      "target": 10,
      "value": 1
    },

    {
      "source": 10,
      "target": 12,
      "value": 1
    },

    {
      "source": 11,
      "target": 13,
      "value": 15
    },

    {
      "source": 13,
      "target": 28,
      "value": 4
    },

    {
      "source": 11,
      "target": 18,
      "value": 1
    },

    {
      "source": 11,
      "target": 24,
      "value": 1
    },

    {
      "source": 24,
      "target": 9,
      "value": 1
    },

    {
      "source": 11,
      "target": 26,
      "value": 1
    },

    {
      "source": 26,
      "target": 12,
      "value": 1
    },

    {
      "source": 14,
      "target": 29,
      "value": 4
    },

    {
      "source": 14,
      "target": 10,
      "value": 1
    },

    {
      "source": 14,
      "target": 16,
      "value": 13
    },

    {
      "source": 14,
      "target": 18,
      "value": 1
    },

    {
      "source": 14,
      "target": 21,
      "value": 3
    },

    {
      "source": 21,
      "target": 15,
      "value": 6
    },

    {
      "source": 14,
      "target": 26,
      "value": 1
    },

    {
      "source": 27,
      "target": 26,
      "value": 12
    },

    {
      "source": 18,
      "target": 12,
      "value": 1
    },

    {
      "source": 19,
      "target": 3,
      "value": 2
    },

    {
      "source": 19,
      "target": 6,
      "value": 9
    },

    {
      "source": 19,
      "target": 29,
      "value": 5
    },

    {
      "source": 19,
      "target": 10,
      "value": 3
    },

    {
      "source": 19,
      "target": 16,
      "value": 2
    },

    {
      "source": 16,
      "target": 2,
      "value": 1
    },

    {
      "source": 19,
      "target": 21,
      "value": 45
    },

    {
      "source": 21,
      "target": 12,
      "value": 1
    },

    {
      "source": 21,
      "target": 17,
      "value": 2
    },

    {
      "source": 19,
      "target": 24,
      "value": 3
    },

    {
      "source": 22,
      "target": 29,
      "value": 5
    },

    {
      "source": 22,
      "target": 6,
      "value": 1
    },

    {
      "source": 22,
      "target": 10,
      "value": 3
    },

    {
      "source": 22,
      "target": 13,
      "value": 1
    },

    {
      "source": 22,
      "target": 16,
      "value": 2
    },

    {
      "source": 22,
      "target": 21,
      "value": 3
    },

    {
      "source": 22,
      "target": 24,
      "value": 24
    },

    {
      "source": 24,
      "target": 28,
      "value": 9
    },

    {
      "source": 24,
      "target": 17,
      "value": 1
    },

    {
      "source": 24,
      "target": 20,
      "value": 1
    },

    {
      "source": 22,
      "target": 26,
      "value": 1
    },

    {
      "source": 27,
      "target": 3,
      "value": 2
    },

    {
      "source": 26,
      "target": 23,
      "value": 1
    }
  ]
};

sankey
    .nodes(energy.nodes)
    .links(energy.links)
    .layout(32);

var link = svg.append("g").selectAll(".link")
    .data(energy.links)
  .enter().append("path")
    .attr("class", "link")
    .attr("d", path)
    .style("stroke-width", function(d) { return Math.max(1, d.dy); })
    .sort(function(a, b) { return b.dy - a.dy; });

link.append("title")
    .text(function(d) { return d.source.name + " → " + d.target.name + "\n" + format(d.value); });

var node = svg.append("g").selectAll(".node")
    .data(energy.nodes)
  .enter().append("g")
    .attr("class", "node")
    .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
  .call(d3.drag()
    .subject(function(d) { return d; })
    .on("start", function() { this.parentNode.appendChild(this); })
    .on("drag", dragmove));

node.append("rect")
    .attr("height", function(d) { return d.dy; })
    .attr("width", sankey.nodeWidth())
    .style("fill", function(d) { return d.color = color(d.name.replace(/ .*/, "")); })
    .style("stroke", "none")
  .append("title")
    .text(function(d) { return d.name + "\n" + format(d.value); });

node.append("text")
    .attr("x", -6)
    .attr("y", function(d) { return d.dy / 2; })
    .attr("dy", ".35em")
    .attr("text-anchor", "end")
    .attr("transform", null)
    .text(function(d) { return d.name; })
  .filter(function(d) { return d.x < width / 2; })
    .attr("x", 6 + sankey.nodeWidth())
    .attr("text-anchor", "start");

function dragmove(d) {
  d3.select(this).attr("transform", "translate(" + d.x + "," + (d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))) + ")");
  sankey.relayout();
  link.attr("d", path);
}

var linkExtent = d3.extent(energy.links, function (d) {return d.value});
var frequencyScale = d3.scaleLinear().domain(linkExtent).range([0.05,1]);
var particleSize = d3.scaleLinear().domain(linkExtent).range([1,5]);


energy.links.forEach(function (link) {
  link.freq = frequencyScale(link.value);
  link.particleSize = 2;
  link.particleColor = d3.scaleLinear().domain([0,1])
  .range([link.source.color, link.target.color]);
})

var t = d3.timer(tick, 1000);
var particles = [];

function tick(elapsed, time) {

  particles = particles.filter(function (d) {return d.current < d.path.getTotalLength()});

  d3.selectAll("path.link")
  .each(
    function (d) {
//        if (d.freq < 1) {
      for (var x = 0;x<2;x++) {
        var offset = (Math.random() - .5) * (d.dy - 4);
        if (Math.random() < d.freq) {
          var length = this.getTotalLength();
          particles.push({link: d, time: elapsed, offset: offset, path: this, length: length, animateTime: length, speed: 0.5 + (Math.random())})
        }
      }

//        }
/*        else {
        for (var x = 0; x<d.freq; x++) {
          var offset = (Math.random() - .5) * d.dy;
          particles.push({link: d, time: elapsed, offset: offset, path: this})
        }
      } */
    });

  particleEdgeCanvasPath(elapsed);
}

function particleEdgeCanvasPath(elapsed) {
  var context = d3.select("canvas").node().getContext("2d")

  context.clearRect(0,0,1000,1000);

    context.fillStyle = "gray";
    context.lineWidth = "1px";
  for (var x in particles) {
      var currentTime = elapsed - particles[x].time;
//        var currentPercent = currentTime / 1000 * particles[x].path.getTotalLength();
      particles[x].current = currentTime * 0.15 * particles[x].speed;
      var currentPos = particles[x].path.getPointAtLength(particles[x].current);
      context.beginPath();
    context.fillStyle = particles[x].link.particleColor(0);
      context.arc(currentPos.x,currentPos.y + particles[x].offset,particles[x].link.particleSize,0,2*Math.PI);
      context.fill();
  }
}


    </script>
</body>
</html>